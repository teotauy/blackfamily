<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Tree CSV Importer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
            padding: 25px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            background: #fafbfc;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .file-upload {
            border: 2px dashed #3498db;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload:hover {
            border-color: #2980b9;
            background: #ecf0f1;
        }

        .file-upload.dragover {
            border-color: #27ae60;
            background: #d5f4e6;
        }

        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .preview-table th,
        .preview-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }

        .preview-table th {
            background: #34495e;
            color: white;
            font-weight: 600;
        }

        .preview-table tr:hover {
            background: #f8f9fa;
        }

        .error-row {
            background: #fdf2f2 !important;
            border-left: 4px solid #e74c3c;
        }

        .warning-row {
            background: #fef9e7 !important;
            border-left: 4px solid #f39c12;
        }

        .success-row {
            background: #f0f9ff !important;
            border-left: 4px solid #27ae60;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-error { background: #e74c3c; }
        .status-warning { background: #f39c12; }
        .status-success { background: #27ae60; }

        .error-message {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 5px;
        }

        .warning-message {
            color: #f39c12;
            font-size: 12px;
            margin-top: 5px;
        }

        .success-message {
            color: #27ae60;
            font-size: 12px;
            margin-top: 5px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-container {
            background: #ecf0f1;
            border-radius: 10px;
            padding: 3px;
            margin: 20px 0;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .progress-bar {
            background: linear-gradient(90deg, #3498db, #2980b9);
            height: 20px;
            border-radius: 8px;
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background-image: linear-gradient(
                -45deg,
                rgba(255, 255, 255, 0.2) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255, 255, 255, 0.2) 50%,
                rgba(255, 255, 255, 0.2) 75%,
                transparent 75%,
                transparent
            );
            background-size: 50px 50px;
            animation: move 2s linear infinite;
        }

        @keyframes move {
            0% { background-position: 0 0; }
            100% { background-position: 50px 50px; }
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            font-weight: 600;
            color: #2c3e50;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            font-size: 0.9em;
            color: #7f8c8d;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .step.active {
            color: #3498db;
            font-weight: 600;
        }

        .step.completed {
            color: #27ae60;
        }

        .step-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .step-icon.pending {
            background: #ecf0f1;
            color: #bdc3c7;
        }

        .step-icon.active {
            background: #3498db;
            color: white;
        }

        .step-icon.completed {
            background: #27ae60;
            color: white;
        }

        .copy-section {
            background: #e8f5e8;
            border: 1px solid #27ae60;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .copy-section h3 {
            color: #27ae60;
            margin-bottom: 15px;
        }

        .json-output {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .instructions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .instructions h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .instructions ul {
            margin-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .required {
            color: #e74c3c;
            font-weight: bold;
        }

        .optional {
            color: #7f8c8d;
            font-style: italic;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå≥ Family Tree CSV Importer</h1>
            <p>Import your family data from Google Sheets or CSV files</p>
        </div>

        <div class="content">
            <div class="instructions">
                <h3>üìã Instructions</h3>
                <ul>
                    <li><strong class="required">Required fields:</strong> Name, Birth Date</li>
                    <li><strong class="optional">Optional fields:</strong> Email, Phone, Address, Pronouns, Can Receive Texts</li>
                    <li>Pronouns: Choose from dropdown or enter custom</li>
                    <li>Can Receive Texts: Use "yes", "no", or "unknown" (unknown defaults to "no")</li>
                    <li>Birth dates should be in YYYY-MM-DD format</li>
                    <li>Phone numbers should include country code if needed</li>
                </ul>
            </div>

            <div class="section">
                <h2>üìÅ Upload or Paste CSV Data</h2>

                <div class="input-group">
                    <label for="csvFile">Upload CSV File:</label>
                    <div class="file-upload" id="fileUpload">
                        <input type="file" id="csvFile" accept=".csv" style="display: none;">
                        <p>üìÅ Drag and drop your CSV file here, or click to browse</p>
                        <p style="font-size: 0.9em; color: #7f8c8d;">Supports .csv files from Google Sheets</p>
                    </div>
                </div>

                <div class="input-group">
                    <label for="csvData">Or paste CSV data directly:</label>
                    <textarea id="csvData" rows="10" placeholder="Paste your CSV data here...&#10;&#10;Example:&#10;Name,Birth Date,Email,Phone,Can Receive Texts,Pronouns&#10;John Doe,1990-01-15,john@example.com,+1234567890,yes,he/him&#10;Jane Smith,1985-05-20,jane@example.com,+1234567891,no,she/her"></textarea>
                </div>

                <button class="btn" id="processBtn">üîÑ Process Data</button>
                <button class="btn btn-secondary" id="clearBtn">üóëÔ∏è Clear</button>
            </div>

            <div class="section hidden" id="previewSection">
                <h2>üëÄ Data Preview & Validation</h2>

                <div class="copy-section hidden" id="copySection">
                    <h3>‚úÖ Data Ready for Import</h3>
                    <p>Your data has been processed and is ready to copy to your family tree app.</p>
                    <button class="btn btn-success" id="copyBtn">üìã Copy to Clipboard</button>
                    <button class="btn btn-warning" id="downloadBtn">üíæ Download JSON</button>
                    <button class="btn btn-primary" id="directImportBtn">üöÄ Import Directly to Family Tree</button>

                    <div class="json-output" id="jsonOutput">
                        <!-- JSON output will be shown here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class CSVImporter {
            constructor() {
                this.processedData = [];
                this.errors = [];
                this.warnings = [];
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                // File upload
                const fileUpload = document.getElementById('fileUpload');
                const csvFile = document.getElementById('csvFile');

                fileUpload.addEventListener('click', () => csvFile.click());
                fileUpload.addEventListener('dragover', this.handleDragOver.bind(this));
                fileUpload.addEventListener('drop', this.handleDrop.bind(this));
                csvFile.addEventListener('change', this.handleFileSelect.bind(this));

                // Buttons
                document.getElementById('processBtn').addEventListener('click', this.processData.bind(this));
                document.getElementById('clearBtn').addEventListener('click', this.clearAll.bind(this));
                document.getElementById('copyBtn').addEventListener('click', this.copyToClipboard.bind(this));
                document.getElementById('downloadBtn').addEventListener('click', this.downloadJSON.bind(this));
                // New button
                document.getElementById('directImportBtn').addEventListener('click', this.directImport.bind(this));
            }

            handleDragOver(e) {
                e.preventDefault();
                document.getElementById('fileUpload').classList.add('dragover');
            }

            handleDrop(e) {
                e.preventDefault();
                document.getElementById('fileUpload').classList.remove('dragover');

                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type === 'text/csv') {
                    this.readFile(files[0]);
                }
            }

            handleFileSelect(e) {
                const file = e.target.files[0];
                if (file) {
                    this.readFile(file);
                }
            }

            readFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('csvData').value = e.target.result;
                };
                reader.readAsText(file);
            }

            processData() {
                const csvData = document.getElementById('csvData').value.trim();
                if (!csvData) {
                    alert('Please provide CSV data first.');
                    return;
                }

                // Hide preview section initially
                const previewSection = document.getElementById('previewSection');
                previewSection.classList.add('hidden');

                console.log('üöÄ Starting CSV processing...');
                this.showLoading();

                // Set a timeout to detect if processing hangs
                window.processingTimeout = setTimeout(() => {
                    console.warn('‚ö†Ô∏è Processing taking longer than expected...');
                    this.updateProgress(2, 50, 'Still finding long lost relatives... (this may take a moment)');
                }, 5000); // 5 seconds

                // Set a hard timeout to prevent infinite hanging
                window.hardTimeout = setTimeout(() => {
                    console.error('‚ùå Processing timeout - taking too long');
                    this.showError('Processing is taking too long. Please try with a smaller dataset or check your CSV format.');
                }, 30000); // 30 seconds

                try {
                    // Simulate processing with progress updates
                    setTimeout(() => {
                        console.log('üìä Step 1: Parsing CSV data...');
                        this.updateProgress(1, 25, 'Parsing CSV data...');

                        setTimeout(() => {
                            try {
                                console.log('üîç Step 2: Finding long lost relatives...');
                                this.parseCSV(csvData);
                                this.updateProgress(2, 50, 'Finding long lost relatives...');

                                setTimeout(() => {
                                    try {
                                        console.log('‚úÖ Step 3: Generating family tree preview...');
                                        this.validateData();
                                        this.updateProgress(3, 75, 'Generating family tree preview...');

                                        setTimeout(() => {
                                            try {
                                                console.log('üéâ Step 4: Family reunion complete!');
                                                this.generatePreview();
                                                this.updateProgress(3, 100, 'Family reunion complete! üéâ');

                                                setTimeout(() => {
                                                    console.log('‚úÖ Processing finished successfully');
                                                    clearTimeout(window.processingTimeout);
                                                    clearTimeout(window.hardTimeout);
                                                    this.hideLoading();
                                                }, 500);
                                            } catch (error) {
                                                console.error('‚ùå Error in generatePreview:', error);
                                                this.showError('Error generating preview: ' + error.message);
                                            }
                                        }, 300);
                                    } catch (error) {
                                        console.error('‚ùå Error in validateData:', error);
                                        this.showError('Error validating data: ' + error.message);
                                    }
                                }, 400);
                            } catch (error) {
                                console.error('‚ùå Error in parseCSV:', error);
                                this.showError('Error parsing CSV: ' + error.message);
                            }
                        }, 300);
                    }, 200);
                } catch (error) {
                    console.error('‚ùå Error in processData:', error);
                    this.showError('Error processing data: ' + error.message);
                }
            }

            showError(message) {
                console.error('üö® Processing Error:', message);
                // Clear any pending timeouts
                if (window.processingTimeout) clearTimeout(window.processingTimeout);
                if (window.hardTimeout) clearTimeout(window.hardTimeout);

                // Show error as an overlay inside the preview section
                let previewSection = document.getElementById('previewSection');
                let errorOverlay = document.getElementById('errorOverlay');
                if (!errorOverlay) {
                    errorOverlay = document.createElement('div');
                    errorOverlay.id = 'errorOverlay';
                    errorOverlay.style.position = 'absolute';
                    errorOverlay.style.top = '0';
                    errorOverlay.style.left = '0';
                    errorOverlay.style.width = '100%';
                    errorOverlay.style.height = '100%';
                    errorOverlay.style.background = 'rgba(255,255,255,0.97)';
                    errorOverlay.style.zIndex = '1000';
                    errorOverlay.style.display = 'flex';
                    errorOverlay.style.flexDirection = 'column';
                    errorOverlay.style.justifyContent = 'center';
                    errorOverlay.style.alignItems = 'center';
                    errorOverlay.style.padding = '40px 10px';
                }
                errorOverlay.innerHTML = `
                    <div style="max-width: 500px; width: 100%; background: #fff; border: 2px solid #e74c3c; border-radius: 12px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); padding: 32px 24px; text-align: center;">
                        <h2 style="color: #e74c3c; margin-bottom: 16px;">‚ùå Processing Error</h2>
                        <div style="background: #fdf2f2; border: 1px solid #e74c3c; border-radius: 8px; padding: 20px; margin: 20px 0;">
                            <p style="color: #e74c3c; font-weight: bold;">${message}</p>
                            <p style="margin-top: 15px;">Please check your CSV data and try again.</p>
                        </div>
                        <button class="btn" id="dismissErrorBtn">üîÑ Try Again</button>
                    </div>
                `;
                previewSection.style.position = 'relative';
                previewSection.appendChild(errorOverlay);

                // Dismiss error overlay and reset preview section on Try Again
                setTimeout(() => {
                    document.getElementById('dismissErrorBtn').onclick = () => {
                        if (errorOverlay && errorOverlay.parentNode) {
                            errorOverlay.parentNode.removeChild(errorOverlay);
                        }
                        // Reset preview section to original HTML
                        previewSection.innerHTML = `
                            <h2>üëÄ Data Preview & Validation</h2>
                            <div class="copy-section hidden" id="copySection">
                                <h3>‚úÖ Data Ready for Import</h3>
                                <p>Your data has been processed and is ready to copy to your family tree app.</p>
                                <button class="btn btn-success" id="copyBtn">üìã Copy to Clipboard</button>
                                <button class="btn btn-warning" id="downloadBtn">üíæ Download JSON</button>
                                <button class="btn btn-primary" id="directImportBtn">üöÄ Import Directly to Family Tree</button>
                                <div class="json-output" id="jsonOutput"></div>
                            </div>
                        `;
                        previewSection.classList.add('hidden');
                        // Re-initialize the CSVImporter class to re-bind everything
                        new CSVImporter();
                    };
                }, 0);
            }

            parseCSV(csvText) {
                const lines = csvText.split('\n').filter(line => line.trim());
                if (lines.length < 2) {
                    throw new Error('CSV must have at least a header row and one data row');
                }

                const headers = this.parseCSVRow(lines[0]);
                this.processedData = [];

                for (let i = 1; i < lines.length; i++) {
                    const values = this.parseCSVRow(lines[i]);
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header.trim()] = values[index] ? values[index].trim() : '';
                    });
                    this.processedData.push(row);
                }
            }

            parseCSVRow(line) {
                const result = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];

                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }

                result.push(current);
                return result.map(item => item.replace(/^"|"$/g, ''));
            }

            // Add a helper to parse and convert dates to YYYY-MM-DD
            parseToISODate(dateStr) {
                if (!dateStr) return '';
                // Accept YYYY-MM-DD
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
                // Accept MM/DD/YY or MM/DD/YYYY
                const mdy = dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
                if (mdy) {
                    let [_, m, d, y] = mdy;
                    if (y.length === 2) {
                        // Assume 19xx for years > 30, else 20xx
                        y = parseInt(y, 10) > 30 ? '19' + y : '20' + y;
                    }
                    return `${y.padStart(4, '0')}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
                }
                return '';
            }

            validateData() {
                this.errors = [];
                this.warnings = [];

                console.log('üîç Starting validation of', this.processedData.length, 'rows...');

                this.processedData.forEach((row, index) => {
                    const rowNum = index + 2; // +2 because of 0-based index and header row

                    console.log(`üìã Validating row ${rowNum}:`, row);

                    // Accept either Name, or (First Name and Last Name)
                    const hasFullName = (row['Name'] && row['Name'].trim()) ||
                        ((row['First Name'] && row['First Name'].trim()) && (row['Last Name'] && row['Last Name'].trim()));
                    if (!hasFullName) {
                        console.log(`‚ùå Row ${rowNum}: Missing name`);
                        this.errors.push(`Row ${rowNum}: Name is required (provide either 'Name' or both 'First Name' and 'Last Name')`);
                    }

                    // Accept DOB in MM/DD/YY, MM/DD/YYYY, or YYYY-MM-DD
                    const dateVal = row['DOB'] || row['Birth Date'];
                    console.log(`üìÖ Row ${rowNum}: DOB value:`, JSON.stringify(dateVal), 'Type:', typeof dateVal);

                    if (!dateVal || dateVal.trim() === '') {
                        console.log(`‚ö†Ô∏è Row ${rowNum}: Missing birth date - will be set to empty string`);
                        // Don't make this an error - just a warning
                        this.warnings.push(`Row ${rowNum}: Birth date is missing (will be set to empty)`);
                    } else {
                        const isoDate = this.parseToISODate(dateVal);
                        if (!isoDate) {
                            console.log(`‚ùå Row ${rowNum}: Invalid date format:`, dateVal);
                            this.errors.push(`Row ${rowNum}: Invalid birth date format. Use MM/DD/YY, MM/DD/YYYY, or YYYY-MM-DD`);
                        } else {
                            console.log(`‚úÖ Row ${rowNum}: Valid date:`, dateVal, '‚Üí', isoDate);
                        }
                    }

                    // Email validation
                    if (row['Email'] && !this.isValidEmail(row['Email'])) {
                        this.warnings.push(`Row ${rowNum}: Invalid email format`);
                    }

                    // Phone validation
                    if (row['Phone'] && !this.isValidPhone(row['Phone'])) {
                        this.warnings.push(`Row ${rowNum}: Phone number may be invalid`);
                    }

                    // Can Receive validation
                    let canReceive = row['Can receive'] || row['Can Receive Texts'] || '';
                    if (canReceive && !['yes', 'no', 'unknown'].includes(canReceive.toLowerCase())) {
                        this.warnings.push(`Row ${rowNum}: "Can receive" should be "yes", "no", or "unknown"`);
                    }

                    // Pronouns validation
                    if (row['Pronouns'] && !this.isValidPronouns(row['Pronouns'])) {
                        this.warnings.push(`Row ${rowNum}: Pronouns format may be invalid`);
                    }
                });

                console.log('‚úÖ Validation complete. Errors:', this.errors.length, 'Warnings:', this.warnings.length);
            }

            isValidDate(dateString) {
                const date = new Date(dateString);
                return date instanceof Date && !isNaN(date) && dateString.match(/^\d{4}-\d{2}-\d{2}$/);
            }

            isValidEmail(email) {
                return email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/);
            }

            isValidPhone(phone) {
                return phone.match(/^[\+]?[1-9][\d]{0,15}$/);
            }

            isValidPronouns(pronouns) {
                return pronouns.match(/^[a-z]+\/[a-z]+(\/[a-z]+)?$/i);
            }

            generatePreview() {
                const previewSection = document.getElementById('previewSection');

                // Show copy section if no errors
                if (this.errors.length === 0) {
                    // Create the copy section if it doesn't exist
                    let copySection = document.getElementById('copySection');
                    if (!copySection) {
                        previewSection.innerHTML = `
                            <h2>üëÄ Data Preview & Validation</h2>
                            <div class="copy-section" id="copySection">
                                <h3>‚úÖ Data Ready for Import</h3>
                                <p>Your data has been processed and is ready to copy to your family tree app.</p>
                                <button class="btn btn-success" id="copyBtn">üìã Copy to Clipboard</button>
                                <button class="btn btn-warning" id="downloadBtn">üíæ Download JSON</button>
                                <button class="btn btn-primary" id="directImportBtn">üöÄ Import Directly to Family Tree</button>
                                <div class="json-output" id="jsonOutput"></div>
                            </div>
                        `;
                        copySection = document.getElementById('copySection');

                        // Re-attach event listeners
                        setTimeout(() => {
                            const copyBtn = document.getElementById('copyBtn');
                            if (copyBtn) copyBtn.addEventListener('click', this.copyToClipboard.bind(this));
                            const downloadBtn = document.getElementById('downloadBtn');
                            if (downloadBtn) downloadBtn.addEventListener('click', this.downloadJSON.bind(this));
                            const directImportBtn = document.getElementById('directImportBtn');
                            if(directImportBtn) directImportBtn.addEventListener('click', this.directImport.bind(this));
                        }, 0);
                    }

                    this.generateJSON();
                } else {
                    // Show validation errors
                    previewSection.innerHTML = `
                        <h2>‚ùå Validation Errors Found</h2>
                        <div style="background: #fdf2f2; border: 1px solid #e74c3c; border-radius: 8px; padding: 20px; margin: 20px 0;">
                            <h3 style="color: #e74c3c; margin-bottom: 15px;">Please fix the following errors:</h3>
                            <ul style="color: #e74c3c; margin-left: 20px;">
                                ${this.errors.map(error => `<li>${this.escapeHtml(error)}</li>`).join('')}
                            </ul>
                        </div>
                        ${this.warnings.length > 0 ? `
                            <div style="background: #fef9e7; border: 1px solid #f39c12; border-radius: 8px; padding: 20px; margin: 20px 0;">
                                <h3 style="color: #f39c12; margin-bottom: 15px;">Warnings (data will still be processed):</h3>
                                <ul style="color: #f39c12; margin-left: 20px;">
                                    ${this.warnings.map(warning => `<li>${this.escapeHtml(warning)}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        <button class="btn" onclick="location.reload()">üîÑ Try Again</button>
                    `;
                }
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            generateJSON() {
                const familyData = this.processedData.map((row, index) => {
                    // Combine First Name, Last Name, Maiden into name
                    let name = '';
                    if (row['First Name'] || row['Last Name']) {
                        name = `${row['First Name'] || ''} ${row['Last Name'] || ''}`.trim();
                        if (row['Maiden']) {
                            name += ` (n√©e ${row['Maiden']})`;
                        }
                    } else {
                        name = row['Name'] || '';
                    }

                    // Convert DOB to ISO format
                    let birthDate = this.parseToISODate(row['DOB'] || row['Birth Date'] || '');

                    const person = {
                        id: index + 1,
                        name: name,
                        birthDate: birthDate,
                        pronouns: row['Pronouns'] || 'they/them',
                        bio: row['Bio'] || row['Notes'] || '',
                        contact: {}
                    };

                    // Contact information
                    if (row['Email']) person.contact.email = row['Email'];
                    if (row['Phone']) person.contact.phone = row['Phone'];
                    if (row['Street']) person.contact.street = row['Street'];
                    if (row['City']) person.contact.city = row['City'];
                    if (row['State']) person.contact.state = row['State'];
                    if (row['ZIP']) person.contact.zip = row['ZIP'];

                    // Handle "Can receive" or "Can Receive Texts"
                    let canReceive = row['Can receive'] || row['Can Receive Texts'] || '';
                    if (canReceive) {
                        canReceive = canReceive.toLowerCase();
                        if (canReceive === 'yes') {
                            person.contact.canReceiveTexts = true;
                        } else if (canReceive === 'no') {
                            person.contact.canReceiveTexts = false;
                        } else if (canReceive === 'unknown') {
                            person.contact.canReceiveTexts = false;
                            person.contact.textStatusUnknown = true; // Flag for cousin bait
                        }
                    }

                    return person;
                });

                const jsonOutput = document.getElementById('jsonOutput');
                jsonOutput.textContent = JSON.stringify(familyData, null, 2);
            }

            async copyToClipboard() {
                const jsonOutput = document.getElementById('jsonOutput');
                const text = jsonOutput.textContent;

                try {
                    await navigator.clipboard.writeText(text);
                    alert('‚úÖ Data copied to clipboard! You can now paste it into your family tree app.');
                } catch (err) {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('‚úÖ Data copied to clipboard! You can now paste it into your family tree app.');
                }
            }

            downloadJSON() {
                const jsonOutput = document.getElementById('jsonOutput');
                const text = jsonOutput.textContent;
                const blob = new Blob([text], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'family-data.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            async directImport() {
                const jsonOutput = document.getElementById('jsonOutput');
                const familyData = JSON.parse(jsonOutput.textContent);

                // Get auth token from parent window
                let authToken = null;
                try {
                    authToken = window.opener?.localStorage.getItem('authToken') || localStorage.getItem('authToken');
                } catch (e) {
                    console.warn('Could not access parent window localStorage');
                }

                if (!authToken) {
                    alert('‚ùå Please make sure you are logged in to the family tree app first.');
                    return;
                }

                const apiUrl = '/api/people';

                try {
                    // Send each person to the backend
                    let successCount = 0;
                    for (const person of familyData) {
                        // Transform person data to match backend format
                        const personData = {
                            name: person.name,
                            birthDate: person.birthDate || null,
                            deathDate: null,
                            pronouns: person.pronouns || null,
                            bio: person.bio || null,
                            notes: null,
                            contact: person.contact || {}
                        };

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${authToken}`
                            },
                            body: JSON.stringify(personData)
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(`HTTP ${response.status}: ${errorData.error || 'Unknown error'}`);
                        }

                        const result = await response.json();
                        console.log('‚úÖ Person imported successfully:', result);
                        successCount++;
                    }

                    // Show success state in the UI
                    const copySection = document.getElementById('copySection');
                    copySection.innerHTML = `
                        <div style="text-align: center; padding: 40px; background: #d5f4e6; border: 2px solid #27ae60; border-radius: 12px;">
                            <h3 style="color: #27ae60; margin-bottom: 20px;">üéâ Import Successful!</h3>
                            <p style="font-size: 18px; margin-bottom: 15px;">Successfully imported <strong>${successCount}</strong> family members to your family tree!</p>
                            <p style="color: #666; margin-bottom: 20px;">The family tree has been updated with the new data.</p>
                            <button onclick="window.close()" style="background: #27ae60; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-size: 16px; cursor: pointer;">Close Window</button>
                        </div>
                    `;
                    
                    // Try to refresh the parent window if it exists
                    if (window.opener && window.opener.location) {
                        try {
                            window.opener.location.reload();
                        } catch (e) {
                            console.log('Could not refresh parent window');
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Error importing family data:', error);
                    alert(`‚ùå Error importing family data: ${error.message}\n\nPlease check the console for more details.`);
                }
            }

            clearAll() {
                document.getElementById('csvData').value = '';
                document.getElementById('csvFile').value = '';
                document.getElementById('previewSection').classList.add('hidden');
                document.getElementById('copySection').classList.add('hidden');
                this.processedData = [];
                this.errors = [];
                this.warnings = [];
            }

            showLoading() {
                const previewSection = document.getElementById('previewSection');
                previewSection.classList.remove('hidden');
                previewSection.innerHTML = `
                    <h2>üîÑ Processing Data...</h2>
                    <div class="loading">
                        <div class="progress-steps">
                            <div class="step" id="step1">
                                <div class="step-icon active">1</div>
                                <span>Parsing CSV</span>
                            </div>
                            <div class="step" id="step2">
                                <div class="step-icon pending">2</div>
                                <span>Validating Data</span>
                            </div>
                            <div class="step" id="step3">
                                <div class="step-icon pending">3</div>
                                <span>Generating Preview</span>
                            </div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar" id="progressBar"></div>
                        </div>
                        <div class="progress-text" id="progressText">Starting...</div>
                    </div>
                `;
            }

            updateProgress(step, percentage, text) {
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');

                if (progressBar && progressText) {
                    progressBar.style.width = percentage + '%';
                    progressText.textContent = text;
                }

                // Update step indicators
                for (let i = 1; i <= 3; i++) {
                    const stepElement = document.getElementById(`step${i}`);
                    const stepIcon = stepElement?.querySelector('.step-icon');

                    if (i < step) {
                        stepElement?.classList.add('completed');
                        stepElement?.classList.remove('active');
                        stepIcon?.classList.add('completed');
                        stepIcon?.classList.remove('active', 'pending');
                    } else if (i === step) {
                        stepElement?.classList.add('active');
                        stepElement?.classList.remove('completed');
                        stepIcon?.classList.add('active');
                        stepIcon?.classList.remove('completed', 'pending');
                    } else {
                        stepElement?.classList.remove('active', 'completed');
                        stepIcon?.classList.add('pending');
                        stepIcon?.classList.remove('active', 'completed');
                    }
                }
            }

            hideLoading() {
                // The generatePreview method will replace the loading content
            }
        }

        // Initialize the importer when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new CSVImporter();
        });
    </script>
</body>
</html>